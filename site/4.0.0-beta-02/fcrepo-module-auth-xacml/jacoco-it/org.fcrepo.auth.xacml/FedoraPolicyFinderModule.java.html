<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>FedoraPolicyFinderModule.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Fedora Repository XACML Authorization Module</a> &gt; <a href="index.source.html" class="el_package">org.fcrepo.auth.xacml</a> &gt; <span class="el_source">FedoraPolicyFinderModule.java</span></div><h1>FedoraPolicyFinderModule.java</h1><pre class="source lang-java linenums">/**
 * Copyright 2014 DuraSpace, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.fcrepo.auth.xacml;

import static org.fcrepo.auth.xacml.URIConstants.POLICY_URI_PREFIX;
import static org.fcrepo.auth.xacml.URIConstants.XACML_POLICY_PROPERTY;
import static org.slf4j.LoggerFactory.getLogger;

import java.net.URI;

import javax.jcr.Node;
import javax.jcr.Property;
import javax.jcr.RepositoryException;
import javax.jcr.Session;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;

import org.fcrepo.http.commons.session.SessionFactory;
import org.fcrepo.kernel.Datastream;
import org.fcrepo.kernel.services.DatastreamService;
import org.fcrepo.kernel.services.NodeService;
import org.jboss.security.xacml.sunxacml.AbstractPolicy;
import org.jboss.security.xacml.sunxacml.EvaluationCtx;
import org.jboss.security.xacml.sunxacml.MatchResult;
import org.jboss.security.xacml.sunxacml.Policy;
import org.jboss.security.xacml.sunxacml.PolicyMetaData;
import org.jboss.security.xacml.sunxacml.PolicySet;
import org.jboss.security.xacml.sunxacml.VersionConstraints;
import org.jboss.security.xacml.sunxacml.attr.AttributeValue;
import org.jboss.security.xacml.sunxacml.cond.EvaluationResult;
import org.jboss.security.xacml.sunxacml.finder.PolicyFinder;
import org.jboss.security.xacml.sunxacml.finder.PolicyFinderModule;
import org.jboss.security.xacml.sunxacml.finder.PolicyFinderResult;
import org.slf4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;
import org.w3c.dom.Document;
import org.w3c.dom.Element;


/**
 * Locates a policy in ModeShape by evaluation context or by URI.
 *
 * @author Gregory Jansen
 * @author bbpennel
 */
@Component(&quot;fedoraPolicyFinderModule&quot;)
<span class="fc" id="L61">public class FedoraPolicyFinderModule extends PolicyFinderModule {</span>

<span class="fc" id="L63">    private static final Logger LOGGER = getLogger(FedoraPolicyFinderModule.class);</span>

    @Autowired
    private SessionFactory sessionFactory;

    @Autowired
    private DatastreamService datastreamService;

    @Autowired
    private NodeService nodeService;

    private PolicyFinder finder;

    /*
     * This policy finder can find by request context.
     * @see org.jboss.security.xacml.sunxacml.finder.PolicyFinderModule#
     * isRequestSupported()
     */
    @Override
    public final boolean isRequestSupported() {
<span class="fc" id="L83">        return true;</span>
    }

    /*
     * This policy finder can find by reference (URI)
     * @see org.jboss.security.xacml.sunxacml.finder.PolicyFinderModule#
     * isIdReferenceSupported()
     */
    @Override
    public final boolean isIdReferenceSupported() {
<span class="fc" id="L93">        return true;</span>
    }

    /**
     * Retrieves the policy from the given policy node
     *
     * @param policyDatastream
     * @return
     */
    private AbstractPolicy getPolicy(final Datastream policyDatastream) {
<span class="fc" id="L103">        return loadPolicy(policyDatastream);</span>
    }

    /**
     * Creates a new policy or policy set object from the given policy node
     *
     * @param policyDatastream
     * @return
     */
    private AbstractPolicy loadPolicy(final Datastream policyDatastream) {
<span class="fc" id="L113">        String policyName = &quot;unparsed&quot;;</span>
        try {
            // create the factory
<span class="fc" id="L116">            final DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();</span>
<span class="fc" id="L117">            factory.setIgnoringComments(true);</span>
<span class="fc" id="L118">            factory.setNamespaceAware(true);</span>
<span class="fc" id="L119">            factory.setValidating(false);</span>

<span class="fc" id="L121">            final DocumentBuilder db = factory.newDocumentBuilder();</span>

            // Parse the policy content
<span class="fc" id="L124">            final Document doc = db.parse(policyDatastream.getContent());</span>

            // handle the policy, if it's a known type
<span class="fc" id="L127">            final Element root = doc.getDocumentElement();</span>
<span class="fc" id="L128">            final String name = root.getTagName();</span>

<span class="fc" id="L130">            policyName = PolicyUtil.getID(doc);</span>
<span class="pc bpc" id="L131" title="1 of 2 branches missed.">            if (name.equals(&quot;Policy&quot;)) {</span>
<span class="nc" id="L132">                return Policy.getInstance(root);</span>
<span class="pc bpc" id="L133" title="1 of 2 branches missed.">            } else if (name.equals(&quot;PolicySet&quot;)) {</span>
<span class="fc" id="L134">                return PolicySet.getInstance(root, finder);</span>
            } else {
                // this isn't a root type that we know how to handle
<span class="nc" id="L137">                throw new Exception(&quot;Unknown root document type: &quot; + name);</span>
            }
<span class="nc" id="L139">        } catch (final Exception e) {</span>
<span class="nc" id="L140">            LOGGER.error(&quot;Unable to parse policy from {}&quot;, policyName, e);</span>
        }

        // a default fall-through in the case of an error
<span class="nc" id="L144">        return null;</span>
    }

    /*
     * Find a policy in ModeShape that is appropriate for the evaluation
     * context.
     * @see
     * org.jboss.security.xacml.sunxacml.finder.PolicyFinderModule#findPolicy
     * (org.jboss.security.xacml.sunxacml.EvaluationCtx)
     */
    @Override
    public final PolicyFinderResult findPolicy(final EvaluationCtx context) {
<span class="fc" id="L156">        final EvaluationResult ridEvalRes = context.getResourceAttribute(</span>
                URI.create(&quot;http://www.w3.org/2001/XMLSchema#string&quot;), URIConstants.ATTRIBUTEID_RESOURCE_ID, null);
<span class="fc" id="L158">        final AttributeValue resourceIdAttValue = ridEvalRes.getAttributeValue();</span>
<span class="fc" id="L159">        String path = resourceIdAttValue.getValue().toString();</span>

<span class="pc bpc" id="L161" title="1 of 2 branches missed.">        if (&quot;&quot;.equals(path.trim())) {</span>
<span class="nc" id="L162">            path = &quot;/&quot;;</span>
        }

        try {
<span class="fc" id="L166">            final Session internalSession = sessionFactory.getInternalSession();</span>

            // Walk up the hierarchy to find the first node with a policy assigned
<span class="fc" id="L169">            Node nodeWithPolicy = PolicyUtil.getFirstRealNode(path, internalSession);</span>
<span class="pc bpc" id="L170" title="1 of 4 branches missed.">            while (nodeWithPolicy != null &amp;&amp; !nodeWithPolicy.hasProperty(XACML_POLICY_PROPERTY)) {</span>
<span class="fc" id="L171">                nodeWithPolicy = nodeWithPolicy.getParent();</span>
            }

            // This should never happen, as PolicyUtil.getFirstRealNode() at least returns the root node.
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">            if (null == nodeWithPolicy) {</span>
<span class="nc" id="L176">                return new PolicyFinderResult();</span>
            }

<span class="fc" id="L179">            final Property prop = nodeWithPolicy.getProperty(XACML_POLICY_PROPERTY);</span>
<span class="fc" id="L180">            final Datastream policyDatastream = datastreamService.asDatastream(prop.getNode());</span>

<span class="pc bpc" id="L182" title="1 of 2 branches missed.">            if (policyDatastream == null) {</span>
<span class="nc" id="L183">                return new PolicyFinderResult();</span>
            }

<span class="fc" id="L186">            final AbstractPolicy policy = getPolicy(policyDatastream);</span>

            // Evaluate if the policy targets match the current context
<span class="fc" id="L189">            final MatchResult match = policy.match(context);</span>
<span class="fc" id="L190">            final int result = match.getResult();</span>

<span class="pc bpc" id="L192" title="1 of 2 branches missed.">            if (result == MatchResult.INDETERMINATE) {</span>
<span class="nc" id="L193">                return new PolicyFinderResult(match.getStatus());</span>
            }

            // Found a good policy, return it
<span class="pc bpc" id="L197" title="1 of 2 branches missed.">            if (result == MatchResult.MATCH) {</span>
<span class="fc" id="L198">                return new PolicyFinderResult(policy);</span>
            }

<span class="nc" id="L201">            return new PolicyFinderResult();</span>
<span class="nc" id="L202">        } catch (final RepositoryException e) {</span>
<span class="nc" id="L203">            LOGGER.warn(&quot;Failed to retrieve a policy for {}&quot;, e, path);</span>
<span class="nc" id="L204">            return new PolicyFinderResult();</span>
        }
    }

    /*
     * Find a policy in ModeShape by reference URI.
     * @see
     * org.jboss.security.xacml.sunxacml.finder.PolicyFinderModule#findPolicy
     * (java.net.URI, int, org.jboss.security.xacml.sunxacml.VersionConstraints,
     * org.jboss.security.xacml.sunxacml.PolicyMetaData)
     */
    @Override
    public final PolicyFinderResult findPolicy(final URI idReference,
                                               final int type,
                                               final VersionConstraints constraints,
                                               final PolicyMetaData parentMetaData) {
        try {
<span class="fc" id="L221">            final String id = idReference.toString();</span>
<span class="pc bpc" id="L222" title="1 of 2 branches missed.">            if (!id.startsWith(POLICY_URI_PREFIX)) {</span>
<span class="nc" id="L223">                LOGGER.warn(&quot;Policy reference must begin with {}, but was {}&quot;, POLICY_URI_PREFIX, id);</span>
<span class="nc" id="L224">                return new PolicyFinderResult();</span>
            }

<span class="fc" id="L227">            final String path = PolicyUtil.getPathForId(id);</span>
<span class="fc" id="L228">            final Session internalSession = sessionFactory.getInternalSession();</span>
<span class="fc" id="L229">            final Datastream policyDatastream = datastreamService.getDatastream(internalSession, path);</span>
<span class="fc" id="L230">            final AbstractPolicy policy = getPolicy(policyDatastream);</span>

<span class="fc" id="L232">            return new PolicyFinderResult(policy);</span>

<span class="nc" id="L234">        } catch (final RepositoryException e) {</span>
<span class="nc" id="L235">            LOGGER.warn(&quot;Failed to retrieve a policy for &quot; + idReference.toString(), e);</span>
<span class="nc" id="L236">            return new PolicyFinderResult();</span>
        }
    }

    /*
     * (non-Javadoc)
     * @see
     * org.jboss.security.xacml.sunxacml.finder.PolicyFinderModule#init(org.
     * jboss.security.xacml.sunxacml.finder.PolicyFinder)
     */
    @Override
    public void init(final PolicyFinder finder) {
<span class="fc" id="L248">        this.finder = finder;</span>
<span class="fc" id="L249">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312101107</span></div></body></html>